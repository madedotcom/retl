#' @import utils
#' @import data.table
#' @import aws.s3

library(data.table)
library(aws.s3)

# To access AWS S3 following environment variables are required:
#
# AWS_S3_BUCKET - defines the name of the bucket in aws s3.
# AWS_S3_ROOT - defines the root path for the project.
#
# Also aws.s3 package required following env variables:
# Sys.setenv("AWS_ACCESS_KEY_ID" = "mykey",
#            "AWS_SECRET_ACCESS_KEY" = "mysecretkey",
#            "AWS_DEFAULT_REGION" = "us-east-1",
#            "AWS_SESSION_TOKEN" = "mytoken")
# See: https://github.com/cloudyr/aws.s3


#' Saves a data.frame structure to AWS S3 as a csv file
#'
#' @export
#' @param df data.frame to save
#' @param path S3 object path starting after root folder.
#' @param bucket name of the S3 bucket
#' @param root project root path that is appended before the path, e.g. "/prod/"
s3PutFile <- function (df, path,
                       bucket = Sys.getenv("AWS_S3_BUCKET"),
                       root = Sys.getenv("AWS_S3_ROOT")) {
  tmp.file <- tempfile()
  on.exit(unlink(tmp.file))

  write.csv(df, file = tmp.file, row.names = F)
  full.path <- paste0(root, path)
  put_object(file = tmp.file, object = full.path, bucket=bucket)
}


#' Loads data from a csv file in AWS S3 to data.table
#'
#' @export
#' @param path is the path to the S3 object
#' @param header flag defines whether file has header
#' @param bucket name of the S3 bucket
#' @param root project root path that is appended before the path
#' @return data.table from the source csv file
s3GetFile <- function(path, header=T,
                      bucket = Sys.getenv("AWS_S3_BUCKET"),
                      root = Sys.getenv("AWS_S3_ROOT")) {
  # Args:
  #   path: S3 path starting after root folder, includes filename. example: "folder/file.ext".
  full.path <- paste0(root, path)
  raw_data <- get_object(full.path, bucket)

  # In case of error, print error message.
  if(!is.raw(raw_data))
    stop(print(raw_data[1:3]))

  data <- iconv(readBin(raw_data, character()), from="UTF-8", to="UTF-8")
  df <- fread(data, header=header, strip.white = F)
  # Replace " ", "-" and "_" with "." in the header.
  names(df) <- gsub(" |_|-", ".", tolower(names(df)))
  return(df)
}

#' Gets the path to the object based on the root path setup via
#' environment variable
#'
#' @export
#' @param relative.path defines the path to the object post project root path.
s3GetObjectPath <- function(relative.path) {
  path <- paste0(Sys.getenv("AWS_S3_ROOT"), relative.path)
  return(path)
}
